<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á - ‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #4F46E5; --primary-light: #818CF8; --primary-dark: #3730A3;
            --secondary: #059669; --secondary-light: #34D399;
            --accent: #D97706; --danger: #DC2626;
            --bg-primary: #F8FAFC; --bg-secondary: #FFFFFF; --bg-card: #F1F5F9; --bg-hover: #E2E8F0;
            --text-primary: #1E293B; --text-secondary: #475569; --text-muted: #94A3B8;
            --border: #E2E8F0; --border-dark: #CBD5E1;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        body { font-family: 'Noto Sans Thai', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        .loading-overlay.hidden { display: none; }
        .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 1rem; color: var(--text-secondary); }
        .sync-status { position: fixed; bottom: 1rem; right: 1rem; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.75rem; display: flex; align-items: center; gap: 0.5rem; z-index: 100; }
        .sync-status.online { background: var(--secondary); color: white; }
        .sync-status.offline { background: var(--danger); color: white; }
        .sync-status.syncing { background: var(--accent); color: white; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .sync-status.syncing .sync-dot { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .header { background: var(--bg-secondary); border-bottom: 1px solid var(--border); padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-sm); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .logo { display: flex; align-items: center; gap: 1rem; }
        .logo-icon { width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: var(--shadow); }
        .logo-text h1 { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); }
        .logo-text p { font-size: 0.75rem; color: var(--text-muted); }
        .nav-tabs { display: flex; gap: 0.25rem; background: var(--bg-card); padding: 0.25rem; border-radius: 12px; }
        .nav-tab { padding: 0.6rem 1.2rem; border: none; background: transparent; color: var(--text-secondary); font-family: inherit; font-size: 0.9rem; font-weight: 500; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; }
        .nav-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
        .nav-tab.active { background: var(--primary); color: white; box-shadow: var(--shadow); }
        .user-section { display: flex; align-items: center; gap: 1rem; }
        .user-section select { padding: 0.6rem 1rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit; font-size: 0.9rem; cursor: pointer; }
        .main-content { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-title { font-size: 1.25rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .view-controls { display: flex; align-items: center; gap: 1rem; }
        .view-tabs { display: flex; gap: 0.25rem; background: var(--bg-card); padding: 0.25rem; border-radius: 10px; border: 1px solid var(--border); }
        .view-tab { padding: 0.5rem 1rem; border: none; background: transparent; color: var(--text-secondary); font-family: inherit; font-size: 0.8rem; font-weight: 500; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; white-space: nowrap; }
        .view-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
        .view-tab.active { background: var(--primary); color: white; }
        .view-content { display: none; }
        .view-content.active { display: block; }
        .timeline-section { margin-bottom: 2.5rem; }
        .timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .timeline-nav { display: flex; align-items: center; gap: 0.75rem; }
        .timeline-nav button { width: 36px; height: 36px; border: 1px solid var(--border); background: var(--bg-secondary); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .timeline-nav button:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .timeline-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); min-width: 200px; text-align: center; }
        .timeline-container { background: var(--bg-secondary); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; box-shadow: var(--shadow-sm); }
        .timeline-scroll { overflow-x: auto; padding: 1rem; }
        .timeline-grid { display: grid; min-width: 1000px; }
        .timeline-header-row { display: grid; grid-template-columns: 180px repeat(28, 1fr); border-bottom: 1px solid var(--border); background: var(--bg-secondary); z-index: 10; }
        .timeline-corner { padding: 0.75rem; font-weight: 600; font-size: 0.85rem; color: var(--text-muted); border-right: 1px solid var(--border); background: var(--bg-card); }
        .timeline-hour { padding: 0.5rem 0.25rem; text-align: center; font-size: 0.7rem; color: var(--text-muted); border-right: 1px solid var(--border); background: var(--bg-card); }
        .timeline-hour.current { background: rgba(79, 70, 229, 0.1); color: var(--primary); font-weight: 600; }
        .timeline-room-row { display: grid; grid-template-columns: 180px repeat(28, 1fr); border-bottom: 1px solid var(--border); min-height: 55px; }
        .timeline-room-name { padding: 0.75rem; display: flex; align-items: center; gap: 0.5rem; border-right: 1px solid var(--border); background: var(--bg-card); position: sticky; left: 0; z-index: 5; }
        .timeline-room-color { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .timeline-room-info { font-size: 0.85rem; font-weight: 500; color: var(--text-primary); }
        .timeline-room-capacity { font-size: 0.7rem; color: var(--text-muted); }
        .timeline-cells { display: contents; }
        .timeline-cell { border-right: 1px solid var(--border); position: relative; cursor: pointer; transition: background 0.2s ease; background: var(--bg-secondary); }
        .timeline-cell:hover { background: rgba(79, 70, 229, 0.05); }
        .timeline-cell.current { background: rgba(79, 70, 229, 0.08); }
        .timeline-cell.past { background: var(--bg-card); cursor: not-allowed; }
        .timeline-booking { position: absolute; top: 4px; bottom: 4px; left: 2px; right: 2px; border-radius: 6px; padding: 0.25rem 0.5rem; font-size: 0.75rem; font-weight: 500; color: white; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; cursor: pointer; z-index: 2; display: flex; align-items: center; box-shadow: var(--shadow-sm); }
        .timeline-booking:hover { transform: scale(1.02); z-index: 10; box-shadow: var(--shadow); }
        .timeline-legend { display: flex; gap: 1.5rem; padding: 1rem; border-top: 1px solid var(--border); flex-wrap: wrap; background: var(--bg-card); }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--text-secondary); }
        .legend-color { width: 16px; height: 16px; border-radius: 4px; }
        .legend-color.available { background: var(--bg-secondary); border: 2px dashed var(--secondary); }
        .legend-color.booked { background: var(--primary); }
        .legend-color.my-booking { background: var(--accent); }
        .week-grid { display: grid; min-width: 900px; }
        .week-header-row { display: grid; grid-template-columns: 70px repeat(7, 1fr); border-bottom: 1px solid var(--border); background: var(--bg-card); }
        .week-corner { padding: 0.75rem 0.5rem; font-weight: 600; font-size: 0.8rem; color: var(--text-muted); border-right: 1px solid var(--border); text-align: center; }
        .week-day-header { padding: 0.75rem 0.5rem; text-align: center; border-right: 1px solid var(--border); }
        .week-day-header.today { background: rgba(79, 70, 229, 0.1); }
        .week-day-name { font-size: 0.8rem; font-weight: 600; color: var(--text-primary); }
        .week-day-date { font-size: 0.75rem; color: var(--text-muted); }
        .week-time-row { display: grid; grid-template-columns: 70px repeat(7, 1fr); border-bottom: 1px solid var(--border); min-height: 50px; }
        .week-time-cell { padding: 0.5rem; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); border-right: 1px solid var(--border); background: var(--bg-card); text-align: center; }
        .week-cell { border-right: 1px solid var(--border); position: relative; cursor: pointer; background: var(--bg-secondary); min-height: 50px; }
        .week-cell:hover { background: rgba(79, 70, 229, 0.05); }
        .week-cell.today { background: rgba(79, 70, 229, 0.05); }
        .week-cell.past { background: var(--bg-card); cursor: not-allowed; }
        .week-booking { position: absolute; top: 2px; left: 2px; right: 2px; border-radius: 4px; padding: 0.2rem 0.4rem; font-size: 0.65rem; font-weight: 500; color: white; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; box-shadow: var(--shadow-sm); }
        .month-container { background: var(--bg-secondary); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; box-shadow: var(--shadow-sm); }
        .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .month-header { padding: 0.75rem; text-align: center; font-weight: 600; font-size: 0.85rem; background: var(--bg-card); color: var(--text-primary); border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); }
        .month-header:last-child { border-right: none; }
        .month-header.weekend { color: var(--danger); }
        .month-day { min-height: 100px; padding: 0.5rem; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); background: var(--bg-secondary); cursor: pointer; }
        .month-day:nth-child(7n) { border-right: none; }
        .month-day:hover { background: rgba(79, 70, 229, 0.05); }
        .month-day.other-month { background: var(--bg-card); opacity: 0.5; }
        .month-day.today { background: rgba(79, 70, 229, 0.1); }
        .month-day-number { font-size: 0.9rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.4rem; }
        .month-day.today .month-day-number { background: var(--primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .month-day.weekend .month-day-number { color: var(--danger); }
        .month-day-bookings { display: flex; flex-direction: column; gap: 2px; }
        .month-booking { font-size: 0.65rem; padding: 0.2rem 0.4rem; border-radius: 4px; color: white; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .month-booking-more { font-size: 0.65rem; color: var(--text-muted); padding: 0.2rem; }
        .room-section { margin-bottom: 2rem; }
        .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.25rem; }
        .room-card { background: var(--bg-secondary); border-radius: 16px; overflow: hidden; border: 1px solid var(--border); transition: all 0.3s ease; box-shadow: var(--shadow-sm); }
        .room-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); border-color: var(--primary-light); }
        .room-image { position: relative; height: 140px; overflow: hidden; }
        .room-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .room-card:hover .room-image img { transform: scale(1.05); }
        .room-image-overlay { position: absolute; inset: 0; background: linear-gradient(to top, rgba(0,0,0,0.5) 0%, transparent 60%); }
        .room-capacity { position: absolute; top: 0.75rem; right: 0.75rem; background: rgba(255,255,255,0.95); padding: 0.3rem 0.6rem; border-radius: 20px; font-size: 0.75rem; font-weight: 500; color: var(--text-primary); }
        .room-status { position: absolute; top: 0.75rem; left: 0.75rem; padding: 0.25rem 0.6rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
        .room-status.available { background: var(--secondary); color: white; }
        .room-status.occupied { background: var(--danger); color: white; }
        .room-content { padding: 1.25rem; }
        .room-name { font-size: 1.05rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.2rem; }
        .room-name-en { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .room-location { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.75rem; }
        .room-facilities { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 1rem; }
        .facility-tag { background: var(--bg-card); padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.65rem; color: var(--text-secondary); border: 1px solid var(--border); }
        .room-actions { display: flex; gap: 0.5rem; }
        .btn { padding: 0.6rem 1.1rem; border: none; border-radius: 8px; font-family: inherit; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; }
        .btn-primary { background: var(--primary); color: white; flex: 1; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); box-shadow: var(--shadow); }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-hover); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #B91C1C; }
        .btn-small { padding: 0.45rem 0.75rem; font-size: 0.8rem; }
        .quick-book-popup { position: fixed; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; box-shadow: var(--shadow-lg); z-index: 200; min-width: 220px; display: none; }
        .quick-book-popup.show { display: block; animation: popIn 0.2s ease; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .quick-book-popup h4 { font-size: 0.9rem; margin-bottom: 0.4rem; color: var(--text-primary); }
        .quick-book-popup p { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.75rem; }
        .quick-book-popup .btn { width: 100%; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 200; padding: 1rem; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: var(--bg-secondary); border-radius: 20px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); box-shadow: var(--shadow-lg); transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); }
        .modal-header h2 { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .modal-close { width: 36px; height: 36px; border: none; background: var(--bg-secondary); border-radius: 8px; color: var(--text-secondary); font-size: 1.25rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: var(--danger); color: white; }
        .modal-body { padding: 1.5rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.4rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-family: inherit; font-size: 0.95rem; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .modal-footer { padding: 1.25rem 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 0.75rem; justify-content: flex-end; background: var(--bg-card); }
        .success-modal .modal { max-width: 380px; text-align: center; }
        .success-icon { width: 70px; height: 70px; background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-light) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin: 0 auto 1.25rem; animation: bounceIn 0.5s ease; color: white; }
        @keyframes bounceIn { 0% { transform: scale(0); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .success-modal h2 { font-size: 1.25rem; margin-bottom: 0.4rem; color: var(--secondary); }
        .success-modal p { color: var(--text-secondary); margin-bottom: 1.25rem; font-size: 0.9rem; }
        .booking-summary { background: var(--bg-card); border-radius: 12px; padding: 1rem; text-align: left; margin-bottom: 1.25rem; border: 1px solid var(--border); }
        .booking-summary-item { display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .booking-summary-item:last-child { border-bottom: none; }
        .booking-summary-item span:first-child { color: var(--text-muted); }
        .booking-summary-item span:last-child { font-weight: 500; color: var(--text-primary); }
        .booking-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .booking-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.25rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; box-shadow: var(--shadow-sm); }
        .booking-card:hover { border-color: var(--primary-light); box-shadow: var(--shadow); }
        .booking-info { display: flex; align-items: center; gap: 1rem; flex: 1; }
        .booking-color { width: 4px; height: 45px; border-radius: 4px; }
        .booking-details h4 { font-size: 0.95rem; font-weight: 600; margin-bottom: 0.2rem; color: var(--text-primary); }
        .booking-details p { font-size: 0.8rem; color: var(--text-secondary); }
        .booking-time { text-align: right; }
        .booking-time .time { font-size: 0.95rem; font-weight: 600; color: var(--primary); }
        .booking-time .duration { font-size: 0.75rem; color: var(--text-muted); }
        .booking-actions { display: flex; gap: 0.5rem; }
        .empty-state { text-align: center; padding: 3rem 2rem; color: var(--text-muted); }
        .empty-state-icon { font-size: 3rem; margin-bottom: 0.75rem; opacity: 0.5; }
        .empty-state h3 { font-size: 1.1rem; margin-bottom: 0.4rem; color: var(--text-secondary); }
        body.signage-mode .header, body.signage-mode .main-content { display: none; }
        .signage-container { min-height: 100vh; padding: 2rem; display: flex; flex-direction: column; background: var(--bg-primary); }
        .signage-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; }
        .signage-room-name { font-size: 2.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem; }
        .signage-location { font-size: 1.1rem; color: var(--text-secondary); }
        .signage-clock { text-align: right; }
        .signage-time { font-size: 3rem; font-weight: 700; font-family: monospace; color: var(--text-primary); }
        .signage-date { font-size: 1.1rem; color: var(--text-secondary); }
        .signage-status { background: var(--bg-secondary); border-radius: 20px; padding: 1.5rem; margin-bottom: 1.5rem; border: 2px solid; box-shadow: var(--shadow); }
        .signage-status.available { border-color: var(--secondary); }
        .signage-status.occupied { border-color: var(--danger); }
        .status-label { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.4rem; }
        .status-text { font-size: 2rem; font-weight: 700; }
        .status-text.available { color: var(--secondary); }
        .status-text.occupied { color: var(--danger); }
        .current-booking { margin-top: 1.25rem; padding-top: 1.25rem; border-top: 1px solid var(--border); }
        .current-booking-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.4rem; color: var(--text-primary); }
        .current-booking-time { font-size: 1.1rem; color: var(--text-secondary); }
        .upcoming-section h3 { font-size: 1.1rem; color: var(--text-muted); margin-bottom: 0.75rem; }
        .upcoming-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .upcoming-item { background: var(--bg-secondary); border-radius: 12px; padding: 1rem 1.25rem; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .upcoming-item .time { font-size: 1.1rem; font-weight: 600; color: var(--primary); min-width: 130px; }
        .upcoming-item .title { font-size: 1rem; flex: 1; color: var(--text-primary); }
        .upcoming-item .booker { color: var(--text-secondary); }
        @media (max-width: 1024px) { .timeline-header { flex-direction: column; align-items: flex-start; } .view-controls { width: 100%; overflow-x: auto; } }
        @media (max-width: 768px) { .header-content { flex-direction: column; } .room-grid { grid-template-columns: 1fr; } .form-row { grid-template-columns: 1fr; } .signage-header { flex-direction: column; gap: 1rem; } .signage-room-name { font-size: 1.75rem; } .signage-time { font-size: 2rem; } }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div><div class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></div>
    <div class="sync-status online" id="syncStatus"><div class="sync-dot"></div><span>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß</span></div>
    <header class="header" id="mainHeader">
        <div class="header-content">
            <div class="logo"><div class="logo-icon">üèõÔ∏è</div><div class="logo-text"><h1>Room Booking System</h1><p>‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏°‡∏ä.</p></div></div>
            <nav class="nav-tabs"><button class="nav-tab active" data-tab="main">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button><button class="nav-tab" data-tab="my-bookings">üìã ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button></nav>
            <div class="user-section"><span style="font-size: 0.85rem; color: var(--text-muted);">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô:</span><select id="currentUserSelect"></select></div>
        </div>
    </header>
    <main class="main-content" id="mainContent">
        <div class="tab-content active" id="main-tab">
            <section class="timeline-section">
                <div class="timeline-header">
                    <h2 class="section-title">üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á</h2>
                    <div class="view-controls"><div class="view-tabs"><button class="view-tab active" data-view="day" onclick="switchView('day')">üìÖ ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</button><button class="view-tab" data-view="week" onclick="switchView('week')">üìÜ ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</button><button class="view-tab" data-view="month" onclick="switchView('month')">üóìÔ∏è ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button></div></div>
                    <div class="timeline-nav"><button onclick="navigatePrev()">‚Üê</button><span class="timeline-title" id="timelineTitle"></span><button onclick="navigateNext()">‚Üí</button><button class="btn btn-secondary btn-small" onclick="goToToday()" style="white-space: nowrap;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button></div>
                </div>
                <div class="view-content active" id="day-view"><div class="timeline-container"><div class="timeline-scroll"><div class="timeline-grid" id="timelineGrid"></div></div><div class="timeline-legend"><div class="legend-item"><div class="legend-color available"></div><span>‡∏ß‡πà‡∏≤‡∏á (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á)</span></div><div class="legend-item"><div class="legend-color booked"></div><span>‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</span></div><div class="legend-item"><div class="legend-color my-booking"></div><span>‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span></div></div></div></div>
                <div class="view-content" id="week-view"><div class="timeline-container"><div class="timeline-scroll"><div class="week-grid" id="weekGrid"></div></div><div class="timeline-legend"><div class="legend-item"><div class="legend-color available"></div><span>‡∏ß‡πà‡∏≤‡∏á</span></div><div class="legend-item"><div class="legend-color booked"></div><span>‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</span></div><div class="legend-item"><div class="legend-color my-booking"></div><span>‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</span></div></div></div></div>
                <div class="view-content" id="month-view"><div class="month-container"><div class="month-grid" id="monthGrid"></div></div></div>
            </section>
            <section class="room-section"><h2 class="section-title">üö™ ‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2><div class="room-grid" id="roomGrid"></div></section>
        </div>
        <div class="tab-content" id="my-bookings-tab"><h2 class="section-title">üìã ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2><div class="booking-list" id="myBookingsList"></div></div>
    </main>
    <div class="signage-container" id="signageDisplay" style="display:none;"></div>
    <div class="quick-book-popup" id="quickBookPopup"><h4 id="quickBookRoom"></h4><p id="quickBookTime"></p><button class="btn btn-primary" onclick="confirmQuickBook()">üìÖ ‡∏à‡∏≠‡∏á‡πÄ‡∏•‡∏¢</button></div>
    <div class="modal-overlay" id="bookingModal">
        <div class="modal">
            <div class="modal-header"><h2 id="bookingModalTitle">üìÖ ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</h2><button class="modal-close" onclick="closeBookingModal()">√ó</button></div>
            <form id="bookingForm" onsubmit="saveBooking(event)">
                <div class="modal-body">
                    <div class="form-group"><label>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á *</label><select id="bookingUser" required></select></div>
                    <div class="form-row"><div class="form-group"><label>‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô *</label><input type="datetime-local" id="bookingStart" required></div><div class="form-group"><label>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ *</label><select id="bookingDuration" required><option value="30">30 ‡∏ô‡∏≤‡∏ó‡∏µ</option><option value="60" selected>1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option><option value="90">1.5 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option><option value="120">2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option><option value="180">3 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option><option value="240">4 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</option></select></div></div>
                    <div class="form-group"><label>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label><textarea id="bookingPurpose" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡πâ‡∏≠‡∏á..."></textarea></div>
                    <input type="hidden" id="bookingRoomId"><input type="hidden" id="bookingId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="deleteBookingBtn" onclick="deleteCurrentBooking()" style="display:none;">üóëÔ∏è ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                    <div style="flex:1;"></div>
                    <button type="button" class="btn btn-secondary" onclick="closeBookingModal()">‡∏õ‡∏¥‡∏î</button>
                    <button type="submit" class="btn btn-primary">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal-overlay success-modal" id="successModal">
        <div class="modal">
            <div class="modal-body" style="padding: 2rem;">
                <div class="success-icon">‚úì</div><h2>‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2><p>‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                <div class="booking-summary" id="bookingSummary"></div>
                <button class="btn btn-primary" onclick="closeSuccessModal()" style="width: 100%;">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>
    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBSCntyH25CqpHXo9aPwxPknwmzeTXpmE8",
            authDomain: "room-booking-cpe-422ae.firebaseapp.com",
            projectId: "room-booking-cpe-422ae",
            storageBucket: "room-booking-cpe-422ae.firebasestorage.app",
            messagingSenderId: "649495675464",
            appId: "1:649495675464:web:c3f44b83871f6368e50e7d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        const TEAMUP_CONFIG = { API_KEY: '633ea517324fcd66017c2f5774ff682f1fc6408998462e06bf5f9e95b2181114', CALENDAR_ID: 'ksbwygkzbudducs6m4' };
        
        const INITIAL_ROOMS = [
            { id: 'meeting-1', name: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 1', nameEn: 'Meeting Room 1', capacity: 12, location: '‡∏ä‡∏±‡πâ‡∏ô 3 ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', facilities: ['‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå', 'Whiteboard', 'Video Conference', 'WiFi'], image: 'https://images.unsplash.com/photo-1497366216548-37526070297c?w=800&h=600&fit=crop', color: '#4F46E5', isActive: true },
            { id: 'meeting-2', name: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 2', nameEn: 'Meeting Room 2', capacity: 8, location: '‡∏ä‡∏±‡πâ‡∏ô 3 ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', facilities: ['TV', 'Whiteboard', 'WiFi'], image: 'https://images.unsplash.com/photo-1497366811353-6870744d04b2?w=800&h=600&fit=crop', color: '#059669', isActive: true },
            { id: 'seminar', name: '‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏±‡∏°‡∏°‡∏ô‡∏≤', nameEn: 'Seminar Room', capacity: 40, location: '‡∏ä‡∏±‡πâ‡∏ô 4 ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', facilities: ['‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå', '‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á', '‡πÑ‡∏°‡∏Ñ‡πå‡∏•‡∏≠‡∏¢', 'Live Streaming'], image: 'https://images.unsplash.com/photo-1517502884422-41eaead166d4?w=800&h=600&fit=crop', color: '#7C3AED', isActive: true },
            { id: 'computer-lab', name: '‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', nameEn: 'Computer Lab', capacity: 30, location: '‡∏ä‡∏±‡πâ‡∏ô 2 ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', facilities: ['‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', '‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡πÄ‡∏ï‡∏≠‡∏£‡πå', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏¥‡πâ‡∏ô'], image: 'https://images.unsplash.com/photo-1606761568499-6d2451b23c66?w=800&h=600&fit=crop', color: '#D97706', isActive: true }
        ];
        
        const INITIAL_USERS = [
            { id: '1', name: '‡∏≠.‡∏î‡∏£.‡∏ò‡∏ô‡∏≤‡∏ò‡∏¥‡∏õ ‡∏ä‡∏±‡∏á‡∏Å‡∏≠‡∏á', email: 'thanatip.c@cmu.ac.th', role: 'admin', isActive: true },
            { id: '2', name: '‡∏≠.‡∏î‡∏£.‡∏Å‡∏£‡∏Å‡∏é ‡πÉ‡∏¢‡∏ö‡∏±‡∏ß‡πÄ‡∏ó‡∏®', email: 'korakot.y@cmu.ac.th', role: 'user', isActive: true },
            { id: '3', name: '‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà - ‡∏ß‡∏¥‡πÑ‡∏•', email: 'wilai.s@cmu.ac.th', role: 'staff', isActive: true },
            { id: '4', name: '‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤ - ‡∏õ.‡πÇ‡∏ó', email: 'grad.master@cmu.ac.th', role: 'user', isActive: true }
        ];
        
        let rooms = [], users = [], bookings = [];
        let currentUserId = null, selectedDate = new Date(), quickBookData = null, currentView = 'day', isInitialized = false;
        
        function generateId() { return Math.random().toString(36).substr(2, 9); }
        function formatDate(date) { return new Date(date).toLocaleDateString('th-TH', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
        function formatTime(date) { return new Date(date).toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }); }
        function formatDateTimeLocal(date) { const d = new Date(date); return new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16); }
        function addMinutes(date, minutes) { return new Date(new Date(date).getTime() + minutes * 60000); }
        function isSameDay(date1, date2) { const d1 = new Date(date1), d2 = new Date(date2); return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate(); }
        function getDateOnly(date) { const d = new Date(date); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
        function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); }
        function updateSyncStatus(status) { const el = document.getElementById('syncStatus'); el.className = 'sync-status ' + status; const m = { online: '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß', offline: '‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå', syncing: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...' }; el.innerHTML = '<div class="sync-dot"></div><span>' + m[status] + '</span>'; }
        
        async function initializeData() {
            showLoading(); updateSyncStatus('syncing');
            try {
                const roomsSnap = await db.collection('rooms').get();
                if (roomsSnap.empty) { for (const r of INITIAL_ROOMS) await db.collection('rooms').doc(r.id).set(r); rooms = [...INITIAL_ROOMS]; }
                else rooms = roomsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const usersSnap = await db.collection('users').get();
                if (usersSnap.empty) { for (const u of INITIAL_USERS) await db.collection('users').doc(u.id).set(u); users = [...INITIAL_USERS]; }
                else users = usersSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                const bookingsSnap = await db.collection('bookings').get();
                bookings = bookingsSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                currentUserId = localStorage.getItem('rb_currentUserId') || users[0]?.id;
                isInitialized = true; updateSyncStatus('online');
            } catch (e) { console.error(e); updateSyncStatus('offline'); rooms = [...INITIAL_ROOMS]; users = [...INITIAL_USERS]; }
            hideLoading();
        }
        
        function setupRealtimeListeners() {
            db.collection('rooms').onSnapshot(s => { rooms = s.docs.map(d => ({ id: d.id, ...d.data() })); if (isInitialized) renderAll(); });
            db.collection('users').onSnapshot(s => { users = s.docs.map(d => ({ id: d.id, ...d.data() })); if (isInitialized) { renderUserSelect(); renderAll(); } });
            db.collection('bookings').onSnapshot(s => { bookings = s.docs.map(d => ({ id: d.id, ...d.data() })); if (isInitialized) renderAll(); });
        }
        
        async function saveBookingToFirebase(booking) { updateSyncStatus('syncing'); try { await db.collection('bookings').doc(booking.id).set(booking); updateSyncStatus('online'); return true; } catch (e) { updateSyncStatus('offline'); return false; } }
        async function deleteBookingFromFirebase(id) { updateSyncStatus('syncing'); try { await db.collection('bookings').doc(id).delete(); updateSyncStatus('online'); return true; } catch (e) { updateSyncStatus('offline'); return false; } }
        
        function renderUserSelect() {
            const select = document.getElementById('currentUserSelect');
            select.innerHTML = users.filter(u => u.isActive).map(u => '<option value="' + u.id + '"' + (u.id === currentUserId ? ' selected' : '') + '>' + u.name + '</option>').join('');
            select.onchange = () => { currentUserId = select.value; localStorage.setItem('rb_currentUserId', currentUserId); renderAll(); };
        }
        
        function renderRoomGrid() {
            const grid = document.getElementById('roomGrid'); const now = new Date();
            grid.innerHTML = rooms.filter(r => r.isActive).map(room => {
                const current = bookings.find(b => { const s = new Date(b.startTime), e = new Date(b.endTime); return b.roomId === room.id && now >= s && now < e; });
                const isAvail = !current;
                return '<div class="room-card"><div class="room-image"><img src="' + room.image + '" alt="' + room.name + '" onerror="this.src=\'https://images.unsplash.com/photo-1497366216548-37526070297c?w=800&h=600&fit=crop\'"><div class="room-image-overlay"></div><div class="room-capacity">üë• ' + room.capacity + ' ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</div><div class="room-status ' + (isAvail ? 'available' : 'occupied') + '">' + (isAvail ? '‡∏ß‡πà‡∏≤‡∏á' : '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á') + '</div></div><div class="room-content"><div style="display:flex;justify-content:space-between;align-items:flex-start;"><div><div class="room-name">' + room.name + '</div><div class="room-name-en">' + (room.nameEn || '') + '</div></div><div style="width:12px;height:12px;border-radius:50%;background:' + room.color + ';"></div></div><div class="room-location">üìç ' + room.location + '</div><div class="room-facilities">' + room.facilities.slice(0, 4).map(f => '<span class="facility-tag">' + f + '</span>').join('') + '</div><div class="room-actions"><button class="btn btn-primary" onclick="openBookingModal(\'' + room.id + '\')">üìÖ ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</button><button class="btn btn-secondary" onclick="openSignage(\'' + room.id + '\')">üñ•Ô∏è</button><button class="btn btn-secondary" onclick="printWeeklySchedule(\'' + room.id + '\')">üñ®Ô∏è</button></div></div></div>';
            }).join('');
        }
        
        function renderTimeline() {
            updateTitle();
            const grid = document.getElementById('timelineGrid'); const now = new Date();
            const currentHour = now.getHours(), isToday = isSameDay(selectedDate, now);
            const activeRooms = rooms.filter(r => r.isActive);
            const hours = []; for (let h = 7; h <= 20; h++) { hours.push({ hour: h, half: 0 }); hours.push({ hour: h, half: 30 }); }
            
            let html = '<div class="timeline-header-row"><div class="timeline-corner">‡∏´‡πâ‡∏≠‡∏á / ‡πÄ‡∏ß‡∏•‡∏≤</div>' + hours.map(h => '<div class="timeline-hour' + (isToday && h.hour === currentHour ? ' current' : '') + '">' + (h.half === 0 ? h.hour + ':00' : '') + '</div>').join('') + '</div>';
            
            activeRooms.forEach(room => {
                const roomBookings = bookings.filter(b => isSameDay(b.startTime, selectedDate) && b.roomId === room.id);
                html += '<div class="timeline-room-row"><div class="timeline-room-name"><div class="timeline-room-color" style="background:' + room.color + ';"></div><div><div class="timeline-room-info">' + room.name + '</div><div class="timeline-room-capacity">üë• ' + room.capacity + '</div></div></div><div class="timeline-cells">';
                hours.forEach(h => {
                    const cellTime = new Date(selectedDate); cellTime.setHours(h.hour, h.half, 0, 0);
                    const isPast = cellTime < now;
                    const booking = roomBookings.find(b => { const s = new Date(b.startTime), e = new Date(b.endTime); return cellTime >= s && cellTime < e; });
                    const isStart = roomBookings.find(b => { const s = new Date(b.startTime); return s.getHours() === h.hour && s.getMinutes() === h.half; });
                    
                    let bookingHtml = '';
                    if (isStart) {
                        const dur = (new Date(isStart.endTime) - new Date(isStart.startTime)) / 60000;
                        const spans = Math.ceil(dur / 30);
                        const isMine = isStart.bookedById === currentUserId;
                        bookingHtml = '<div class="timeline-booking" style="width:calc(' + spans * 100 + '% + ' + (spans - 1) + 'px);background:' + (isMine ? 'var(--accent)' : room.color) + ';" onclick="event.stopPropagation();' + (isMine ? "editBooking('" + isStart.id + "')" : '') + '" title="' + isStart.bookedBy + ': ' + (isStart.purpose || '‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á') + '">' + isStart.bookedBy.split(' ')[0] + '</div>';
                    }
                    html += '<div class="timeline-cell' + (isPast ? ' past' : '') + '" onclick="' + (!booking && !isPast ? "showQuickBook('" + room.id + "','" + cellTime.toISOString() + "',event)" : '') + '">' + bookingHtml + '</div>';
                });
                html += '</div></div>';
            });
            grid.innerHTML = html;
        }
        
        function renderWeekView() {
            const grid = document.getElementById('weekGrid'); const now = new Date();
            const monday = getMonday(selectedDate);
            const dayNames = ['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå', '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'];
            const weekDays = []; for (let i = 0; i < 7; i++) { const d = new Date(monday); d.setDate(monday.getDate() + i); weekDays.push({ date: d, name: dayNames[i], dateStr: d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }), isToday: isSameDay(d, now) }); }
            
            let html = '<div class="week-header-row"><div class="week-corner">‡πÄ‡∏ß‡∏•‡∏≤</div>' + weekDays.map(d => '<div class="week-day-header' + (d.isToday ? ' today' : '') + '"><div class="week-day-name">' + d.name + '</div><div class="week-day-date">' + d.dateStr + '</div></div>').join('') + '</div>';
            
            for (let h = 7; h <= 20; h++) {
                html += '<div class="week-time-row"><div class="week-time-cell">' + h.toString().padStart(2, '0') + ':00</div>';
                weekDays.forEach(day => {
                    const cellTime = new Date(day.date); cellTime.setHours(h, 0, 0, 0);
                    const isPast = cellTime < now;
                    const cellBookings = bookings.filter(b => { const s = new Date(b.startTime), e = new Date(b.endTime); const ss = new Date(day.date); ss.setHours(h, 0, 0, 0); const se = new Date(day.date); se.setHours(h, 59, 59, 999); return s <= se && e > ss; });
                    let bHtml = ''; cellBookings.slice(0, 2).forEach((b, idx) => { const room = rooms.find(r => r.id === b.roomId); const isMine = b.bookedById === currentUserId; bHtml += '<div class="week-booking" style="top:' + (idx * 24 + 2) + 'px;background:' + (isMine ? 'var(--accent)' : (room?.color || '#4F46E5')) + ';" title="' + (room?.name || '') + ': ' + b.bookedBy + '">' + (room?.name?.substring(0, 6) || '') + ' - ' + b.bookedBy.split(' ')[0] + '</div>'; });
                    if (cellBookings.length > 2) bHtml += '<div class="week-booking" style="top:50px;background:var(--text-muted);">+' + (cellBookings.length - 2) + '</div>';
                    html += '<div class="week-cell' + (day.isToday ? ' today' : '') + (isPast ? ' past' : '') + '" onclick="' + (!isPast && cellBookings.length === 0 ? "showQuickBookWeek('" + cellTime.toISOString() + "',event)" : '') + '">' + bHtml + '</div>';
                });
                html += '</div>';
            }
            grid.innerHTML = html;
        }
        
        function renderMonthView() {
            const grid = document.getElementById('monthGrid'); const now = new Date();
            const year = selectedDate.getFullYear(), month = selectedDate.getMonth();
            const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
            let startDate = new Date(firstDay); const fdw = firstDay.getDay(); startDate.setDate(firstDay.getDate() - (fdw === 0 ? 6 : fdw - 1));
            const dayNames = ['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå', '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå'];
            
            let html = dayNames.map((n, i) => '<div class="month-header' + (i >= 5 ? ' weekend' : '') + '">' + n + '</div>').join('');
            let cd = new Date(startDate);
            for (let i = 0; i < 42; i++) {
                const isCurr = cd.getMonth() === month, isToday = isSameDay(cd, now), isWknd = cd.getDay() === 0 || cd.getDay() === 6;
                const dayBookings = bookings.filter(b => isSameDay(b.startTime, cd)).sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
                let bHtml = ''; dayBookings.slice(0, 3).forEach(b => { const room = rooms.find(r => r.id === b.roomId); const isMine = b.bookedById === currentUserId; bHtml += '<div class="month-booking" style="background:' + (isMine ? 'var(--accent)' : (room?.color || '#4F46E5')) + ';">' + formatTime(b.startTime) + ' ' + (room?.name?.substring(0, 6) || '') + '</div>'; });
                if (dayBookings.length > 3) bHtml += '<div class="month-booking-more">+' + (dayBookings.length - 3) + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>';
                html += '<div class="month-day' + (!isCurr ? ' other-month' : '') + (isToday ? ' today' : '') + (isWknd ? ' weekend' : '') + '" onclick="viewDayBookings(\'' + cd.toISOString() + '\')"><div class="month-day-number">' + cd.getDate() + '</div><div class="month-day-bookings">' + bHtml + '</div></div>';
                cd.setDate(cd.getDate() + 1);
                if (cd > lastDay && cd.getDay() === 1) break;
            }
            grid.innerHTML = html;
        }
        
        function renderMyBookings() {
            const now = new Date();
            const myBookings = bookings.filter(b => b.bookedById === currentUserId && new Date(b.endTime) >= now).sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
            const list = document.getElementById('myBookingsList');
            if (myBookings.length === 0) { list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h3><p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</p></div>'; return; }
            let lastDate = '';
            list.innerHTML = myBookings.map(b => {
                const room = rooms.find(r => r.id === b.roomId); const dateStr = formatDate(b.startTime);
                const dateHeader = dateStr !== lastDate ? '<div style="font-size:0.85rem;color:var(--text-muted);margin:1.25rem 0 0.6rem 0.25rem;font-weight:500;">' + dateStr + '</div>' : '';
                lastDate = dateStr;
                const start = new Date(b.startTime), end = new Date(b.endTime), dur = (end - start) / 60000;
                return dateHeader + '<div class="booking-card"><div class="booking-info"><div class="booking-color" style="background:' + (room?.color || '#4F46E5') + ';"></div><div class="booking-details"><h4>' + (room?.name || b.roomName) + '</h4><p>' + (b.purpose || '‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á') + '</p></div></div><div class="booking-time"><div class="time">' + formatTime(start) + ' - ' + formatTime(end) + '</div><div class="duration">' + (dur >= 60 ? (dur / 60) + ' ‡∏ä‡∏°.' : dur + ' ‡∏ô‡∏≤‡∏ó‡∏µ') + '</div></div><div class="booking-actions"><button class="btn btn-secondary btn-small" onclick="editBooking(\'' + b.id + '\')">‚úèÔ∏è</button><button class="btn btn-danger btn-small" onclick="deleteBooking(\'' + b.id + '\')">üóëÔ∏è</button></div></div>';
            }).join('');
        }
        
        function renderAll() { renderRoomGrid(); renderCurrentView(); renderMyBookings(); }
        
        function setupTabs() { document.querySelectorAll('.nav-tab').forEach(tab => { tab.onclick = () => { document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active')); document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); tab.classList.add('active'); document.getElementById(tab.dataset.tab + '-tab').classList.add('active'); }; }); }
        
        function getMonday(date) { const d = new Date(date); const day = d.getDay(); d.setDate(d.getDate() - day + (day === 0 ? -6 : 1)); return d; }
        function navigatePrev() { if (currentView === 'day') selectedDate.setDate(selectedDate.getDate() - 1); else if (currentView === 'week') selectedDate.setDate(selectedDate.getDate() - 7); else selectedDate.setMonth(selectedDate.getMonth() - 1); renderCurrentView(); }
        function navigateNext() { if (currentView === 'day') selectedDate.setDate(selectedDate.getDate() + 1); else if (currentView === 'week') selectedDate.setDate(selectedDate.getDate() + 7); else selectedDate.setMonth(selectedDate.getMonth() + 1); renderCurrentView(); }
        function goToToday() { selectedDate = new Date(); renderCurrentView(); }
        function switchView(view) { currentView = view; document.querySelectorAll('.view-tab').forEach(t => t.classList.toggle('active', t.dataset.view === view)); document.querySelectorAll('.view-content').forEach(c => c.classList.remove('active')); document.getElementById(view + '-view').classList.add('active'); renderCurrentView(); }
        function renderCurrentView() { updateTitle(); if (currentView === 'day') renderTimeline(); else if (currentView === 'week') renderWeekView(); else renderMonthView(); }
        function updateTitle() { const el = document.getElementById('timelineTitle'); if (currentView === 'day') el.textContent = formatDate(selectedDate); else if (currentView === 'week') { const m = getMonday(selectedDate), s = new Date(m); s.setDate(m.getDate() + 6); el.textContent = m.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }) + ' - ' + s.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' }); } else el.textContent = selectedDate.toLocaleDateString('th-TH', { month: 'long', year: 'numeric' }); }
        function viewDayBookings(dateStr) { selectedDate = new Date(dateStr); switchView('day'); }
        
        function showQuickBook(roomId, timeStr, event) { const room = rooms.find(r => r.id === roomId); const time = new Date(timeStr); quickBookData = { roomId, time }; const popup = document.getElementById('quickBookPopup'); document.getElementById('quickBookRoom').textContent = room.name; document.getElementById('quickBookTime').textContent = formatTime(time) + ' - ' + formatTime(addMinutes(time, 60)); popup.style.left = Math.min(event.pageX, window.innerWidth - 250) + 'px'; popup.style.top = Math.min(event.pageY, window.innerHeight - 120) + 'px'; popup.classList.add('show'); setTimeout(() => document.addEventListener('click', closeQuickBook), 100); }
        function showQuickBookWeek(timeStr, event) { const time = new Date(timeStr); const activeRooms = rooms.filter(r => r.isActive); const popup = document.getElementById('quickBookPopup'); document.getElementById('quickBookRoom').innerHTML = '<select id="quickRoomSelect" style="width:100%;padding:0.5rem;border-radius:6px;border:1px solid var(--border);margin-bottom:0.5rem;">' + activeRooms.map(r => '<option value="' + r.id + '">' + r.name + '</option>').join('') + '</select>'; document.getElementById('quickBookTime').textContent = formatTime(time) + ' - ' + formatTime(addMinutes(time, 60)); quickBookData = { time }; popup.style.left = Math.min(event.pageX, window.innerWidth - 250) + 'px'; popup.style.top = Math.min(event.pageY, window.innerHeight - 120) + 'px'; popup.classList.add('show'); setTimeout(() => document.addEventListener('click', closeQuickBook), 100); }
        function closeQuickBook() { document.getElementById('quickBookPopup').classList.remove('show'); document.removeEventListener('click', closeQuickBook); }
        function confirmQuickBook() { if (quickBookData) { let roomId = quickBookData.roomId; const sel = document.getElementById('quickRoomSelect'); if (sel) roomId = sel.value; if (roomId) openBookingModal(roomId, null, quickBookData.time); } closeQuickBook(); }
        
        function openBookingModal(roomId, bookingId = null, presetTime = null) { const modal = document.getElementById('bookingModal'); const room = rooms.find(r => r.id === roomId); const userSelect = document.getElementById('bookingUser'); userSelect.innerHTML = users.filter(u => u.isActive).map(u => '<option value="' + u.id + '">' + u.name + '</option>').join(''); const deleteBtn = document.getElementById('deleteBookingBtn'); if (bookingId) { const b = bookings.find(x => x.id === bookingId); document.getElementById('bookingModalTitle').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á - ' + room?.name; document.getElementById('bookingUser').value = b.bookedById; document.getElementById('bookingStart').value = formatDateTimeLocal(b.startTime); document.getElementById('bookingDuration').value = b.duration; document.getElementById('bookingPurpose').value = b.purpose || ''; document.getElementById('bookingId').value = bookingId; deleteBtn.style.display = 'inline-flex'; } else { document.getElementById('bookingModalTitle').textContent = 'üìÖ ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á - ' + room?.name; document.getElementById('bookingUser').value = currentUserId; document.getElementById('bookingStart').value = formatDateTimeLocal(presetTime || new Date()); document.getElementById('bookingDuration').value = '60'; document.getElementById('bookingPurpose').value = ''; document.getElementById('bookingId').value = ''; deleteBtn.style.display = 'none'; } document.getElementById('bookingRoomId').value = roomId; modal.classList.add('active'); }
        function closeBookingModal() { document.getElementById('bookingModal').classList.remove('active'); }
        
        async function deleteCurrentBooking() {
            const bookingId = document.getElementById('bookingId').value;
            if (!bookingId) return;
            if (confirm('‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ')) {
                const success = await deleteBookingFromFirebase(bookingId);
                if (success) {
                    closeBookingModal();
                    alert('‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                } else {
                    alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà');
                }
            }
        }
        
        async function saveBooking(event) { event.preventDefault(); const id = document.getElementById('bookingId').value; const roomId = document.getElementById('bookingRoomId').value; const userId = document.getElementById('bookingUser').value; const user = users.find(u => u.id === userId); const room = rooms.find(r => r.id === roomId); const startTime = new Date(document.getElementById('bookingStart').value); const duration = parseInt(document.getElementById('bookingDuration').value); const endTime = addMinutes(startTime, duration); const purpose = document.getElementById('bookingPurpose').value; const hasConflict = bookings.some(b => { if (b.id === id || b.roomId !== roomId) return false; const s = new Date(b.startTime), e = new Date(b.endTime); return (startTime < e && endTime > s); }); if (hasConflict) { alert('‚ùå ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß'); return; } const booking = { id: id || generateId(), roomId, roomName: room?.name, bookedById: userId, bookedBy: user?.name, startTime: startTime.toISOString(), endTime: endTime.toISOString(), duration, purpose }; const success = await saveBookingToFirebase(booking); if (success) { closeBookingModal(); showSuccessModal(booking, room); } else { alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà'); } }
        function editBooking(id) { const b = bookings.find(x => x.id === id); if (b && b.bookedById === currentUserId) openBookingModal(b.roomId, id); }
        async function deleteBooking(id) { if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) await deleteBookingFromFirebase(id); }
        
        function showSuccessModal(booking, room) { const sum = document.getElementById('bookingSummary'); sum.innerHTML = '<div class="booking-summary-item"><span>‡∏´‡πâ‡∏≠‡∏á</span><span>' + room?.name + '</span></div><div class="booking-summary-item"><span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span><span>' + formatDate(booking.startTime) + '</span></div><div class="booking-summary-item"><span>‡πÄ‡∏ß‡∏•‡∏≤</span><span>' + formatTime(booking.startTime) + ' - ' + formatTime(booking.endTime) + '</span></div><div class="booking-summary-item"><span>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</span><span>' + booking.bookedBy + '</span></div>' + (booking.purpose ? '<div class="booking-summary-item"><span>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</span><span>' + booking.purpose + '</span></div>' : ''); document.getElementById('successModal').classList.add('active'); }
        function closeSuccessModal() { document.getElementById('successModal').classList.remove('active'); }
        
        function printWeeklySchedule(roomId) { 
            const room = rooms.find(r => r.id === roomId); if (!room) return; 
            const today = new Date(), dow = today.getDay(); 
            const monday = new Date(today); monday.setDate(today.getDate() - (dow === 0 ? 6 : dow - 1)); monday.setHours(0, 0, 0, 0); 
            const dayNames = ['‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå', '‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£', '‡∏û‡∏∏‡∏ò', '‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ', '‡∏®‡∏∏‡∏Å‡∏£‡πå', '‡πÄ‡∏™‡∏≤‡∏£‡πå', '‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå']; 
            const weekDays = []; for (let i = 0; i < 7; i++) { const d = new Date(monday); d.setDate(monday.getDate() + i); weekDays.push({ date: d, name: dayNames[i], dateStr: d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }) }); } 
            const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6); sunday.setHours(23, 59, 59, 999); 
            const weekBookings = bookings.filter(b => { const s = new Date(b.startTime); return b.roomId === roomId && s >= monday && s <= sunday; }); 
            const timeSlots = []; for (let h = 7; h <= 20; h++) timeSlots.push(h.toString().padStart(2, '0') + ':00'); 
            let tableRows = ''; 
            timeSlots.forEach(time => { 
                const hour = parseInt(time.split(':')[0]); 
                let row = '<tr><td class="time-cell">' + time + '</td>'; 
                weekDays.forEach(day => { 
                    const dayB = weekBookings.filter(b => { const s = new Date(b.startTime), e = new Date(b.endTime); const ss = new Date(day.date); ss.setHours(hour, 0, 0, 0); const se = new Date(day.date); se.setHours(hour, 59, 59, 999); return s <= se && e > ss; }); 
                    if (dayB.length > 0) { 
                        const b = dayB[0]; const st = new Date(b.startTime), et = new Date(b.endTime); 
                        const ts = st.getHours().toString().padStart(2, '0') + ':' + st.getMinutes().toString().padStart(2, '0') + '-' + et.getHours().toString().padStart(2, '0') + ':' + et.getMinutes().toString().padStart(2, '0'); 
                        row += '<td class="booked-cell"><div class="booking-info-print"><strong>' + (b.bookedBy?.split(' ')[0] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') + '</strong><span class="booking-time-print">' + ts + '</span></div></td>'; 
                    } else { row += '<td class="empty-cell"></td>'; } 
                }); 
                row += '</tr>'; tableRows += row; 
            }); 
            const printWin = window.open('', '_blank'); 
            const now = new Date(); 
            const updateDate = now.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }); 
            const weekRange = monday.toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }) + ' - ' + sunday.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' }); 
            const qrCodeBase64 = 'data:image/webp;base64,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';
            printWin.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ' + room.name + '</title><style>@page{size:A4 landscape;margin:8mm}*{margin:0;padding:0;box-sizing:border-box}body{font-family:sans-serif;font-size:9pt;color:#333}.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;padding-bottom:8px;border-bottom:2px solid #4F46E5}.header-left{flex:1}.header h1{font-size:16pt;color:#4F46E5;margin-bottom:2px}.header h2{font-size:11pt;color:#666;margin-bottom:2px}.room-info{font-size:9pt;color:#666;margin-bottom:1px}.update-date{font-size:8pt;color:#888}.header-right{display:flex;align-items:center;gap:8px;text-align:right}.qr-code{width:55px;height:55px}.qr-info{text-align:right}.qr-info p{font-size:7pt;color:#666;margin-bottom:1px}.qr-info a{color:#4F46E5;font-weight:bold;font-size:8pt;text-decoration:none}table{width:100%;border-collapse:collapse;table-layout:fixed}th,td{border:1px solid #ddd;padding:2px 1px;text-align:center;vertical-align:middle;font-size:7pt}th{background:#4F46E5;color:white;padding:3px 1px}th.time-header{width:40px;background:#3730A3}.day-name{font-size:8pt;display:block}.day-date{font-size:7pt;font-weight:normal;opacity:0.9}.time-cell{background:#f8fafc;font-weight:bold;font-size:7pt;width:40px}.empty-cell{background:#fff;height:26px}.booked-cell{background:#EEF2FF;height:26px;padding:1px}.booking-info-print{display:flex;flex-direction:column;align-items:center;gap:0}.booking-info-print strong{font-size:6pt;color:#4F46E5;line-height:1.1}.booking-time-print{font-size:5pt;color:#666;line-height:1.1}.footer{margin-top:5px;text-align:center;font-size:7pt;color:#888;padding-top:4px;border-top:1px solid #ddd}@media print{body{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important}}</style></head><body><div class="header"><div class="header-left"><h1>üìÖ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ' + room.name + '</h1><h2>' + (room.nameEn || '') + '</h2><div class="room-info">üìç ' + room.location + ' | üë• ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ ' + room.capacity + ' ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á | üìÜ ' + weekRange + '</div><div class="update-date">üïê ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó: ' + updateDate + '</div></div><div class="header-right"><div class="qr-info"><p>üì± ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á</p><a href="https://cmu.to/RoomReserveCPE">cmu.to/RoomReserveCPE</a></div><img class="qr-code" src="' + qrCodeBase64 + '" alt="QR Code"></div></div><table><thead><tr><th class="time-header">‡πÄ‡∏ß‡∏•‡∏≤</th>' + weekDays.map(d => '<th><span class="day-name">' + d.name + '</span><span class="day-date">' + d.dateStr + '</span></th>').join('') + '</tr></thead><tbody>' + tableRows + '</tbody></table><div class="footer">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á - ‡∏†‡∏≤‡∏Ñ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå ‡∏Ñ‡∏ì‡∏∞‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</div><script>window.onload=function(){window.print();}<\/script></body></html>'); 
            printWin.document.close(); 
        }
        
        function openSignage(roomId) { window.open(window.location.pathname + '?display=' + roomId, '_blank'); }
        function renderSignage(roomId) { document.body.classList.add('signage-mode'); document.getElementById('signageDisplay').style.display = 'flex'; const room = rooms.find(r => r.id === roomId); if (!room) { document.getElementById('signageDisplay').innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚ùå</div><h3>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏</h3></div>'; return; } function update() { const now = new Date(); const roomB = bookings.filter(b => b.roomId === roomId).sort((a, b) => new Date(a.startTime) - new Date(b.startTime)); const curr = roomB.find(b => { const s = new Date(b.startTime), e = new Date(b.endTime); return now >= s && now < e; }); const upcoming = roomB.filter(b => new Date(b.startTime) > now).slice(0, 5); document.getElementById('signageDisplay').innerHTML = '<div class="signage-header"><div><div class="signage-room-name">' + room.name + '</div><div class="signage-location">üìç ' + room.location + ' | üë• ' + room.capacity + ' ‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</div></div><div class="signage-clock"><div class="signage-time">' + now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) + '</div><div class="signage-date">' + formatDate(now) + '</div></div></div><div class="signage-status ' + (curr ? 'occupied' : 'available') + '"><div class="status-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</div><div class="status-text ' + (curr ? 'occupied' : 'available') + '">' + (curr ? 'üî¥ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á' : 'üü¢ ‡∏ß‡πà‡∏≤‡∏á') + '</div>' + (curr ? '<div class="current-booking"><div class="current-booking-title">' + (curr.purpose || '‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°') + ' - ' + curr.bookedBy + '</div><div class="current-booking-time">' + formatTime(curr.startTime) + ' - ' + formatTime(curr.endTime) + '</div></div>' : '') + '</div><div class="upcoming-section"><h3>üìã ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏°‡∏≤‡∏ñ‡∏∂‡∏á</h3>' + (upcoming.length === 0 ? '<div class="empty-state" style="padding:2rem;"><p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</p></div>' : '<div class="upcoming-list">' + upcoming.map(b => '<div class="upcoming-item"><div class="time">' + formatTime(b.startTime) + ' - ' + formatTime(b.endTime) + '</div><div class="title">' + (b.purpose || '‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°') + '</div><div class="booker">' + b.bookedBy + '</div></div>').join('') + '</div>') + '</div>'; } update(); setInterval(update, 1000); }
        
        async function init() { const urlParams = new URLSearchParams(window.location.search); const displayRoom = urlParams.get('display'); await initializeData(); setupRealtimeListeners(); if (displayRoom) { renderSignage(displayRoom); } else { renderUserSelect(); setupTabs(); renderAll(); } }
        init();
    </script>
</body>
</html>
